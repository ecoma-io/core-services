name: Integration
# CI workflow for the monorepo. Runs lint/test/build/e2e on affected projects
# and a release job that runs only on pushes to `main`.

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  merge_group:

jobs:
  # Job 1: Compute affected projects list
  compute-affected:
    name: Compute affected projects
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.affected.outputs.projects }}
      has_projects: ${{ steps.affected.outputs.has_projects }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Set NX_BASE and NX_HEAD SHAs
        uses: nrwl/nx-set-shas@v4
        with:
          main-branch-name: 'main'

      - name: Compute affected projects
        id: affected
        run: |
          set -euo pipefail

          # Use nx show projects --affected which now uses NX_BASE and NX_HEAD
          # set by the nx-set-shas action
          PROJECTS_JSON=$(npx nx show projects --affected --json)

          echo "projects=$PROJECTS_JSON" >> "$GITHUB_OUTPUT"

          # Check if we have any projects
          PROJECT_COUNT=$(echo "$PROJECTS_JSON" | jq '. | length')
          if [ "$PROJECT_COUNT" -gt 0 ]; then
            echo "has_projects=true" >> "$GITHUB_OUTPUT"
            echo "Found $PROJECT_COUNT affected project(s)"
          else
            echo "has_projects=false" >> "$GITHUB_OUTPUT"
            echo "No affected projects found"
          fi

          echo "Projects: $PROJECTS_JSON"

  # Job 2: Run integration checks in parallel via matrix
  integration-checks:
    name: Check ${{ matrix.project }}
    needs: compute-affected
    if: needs.compute-affected.outputs.has_projects == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.compute-affected.outputs.projects) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup project
        uses: ./.github/actions/setup-project

      - name: Run integration checks for ${{ matrix.project }}
        run: npx nx run-many -t lint test build e2e --projects=${{ matrix.project }}

  release:
    # Release job: runs only on push to main and creates a release via
    # googleapis/release-please-action. Uses a GitHub App token generated
    # earlier in the steps to allow write access for tagging/release creation.
    name: Release
    needs: [integration-checks]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Generate App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private_key: ${{ secrets.RELEASE_BOT_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.generate_token.outputs.token }}

      - name: Release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        id: release-please
        with:
          token: ${{ steps.generate_token.outputs.token }}
          release-type: node

  report:
    # Reporting job: always runs (even if previous jobs are skipped/failed)
    # and sets a GitHub status via an external action.
    name: Report
    needs: [integration-checks, release]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Setup project
        uses: guibranco/github-status-action-v2@latest
        with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: ci-completed
          # If neither dependency returned 'failure', mark the state as
          # 'success'. Otherwise, 'failure'.
          state: ${{ (needs.integration-checks.result != 'failure' && needs.release.result != 'failure') && 'success' || 'failure' }}
          sha: ${{github.event.pull_request.head.sha || github.sha}}
